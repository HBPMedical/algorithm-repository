---

name: t-SNE

doc: |
  t-Distributed Stochastic Neighbor Embedding,
  a technique for dimensionality reduction.

metadata:
  docker_image: "{{ docker_image }}"

input:
  type: "null"

output:
  doc: "No output"
  type: "null"

cells:
  query:
    type:
      doc: "Definition of the query that has produced this model"
      name: Query
      type: record
      fields:
        -
          name: "variables"
          doc: "List of dependent variables"
          type:
            type: "array"
            items:
              type: "string"
        -
          name: "covariables"
          doc: "List of explanatory variables"
          type:
            type: "array"
            items:
              type: "string"
        -
          name: "grouping"
          doc: "List of groupings"
          type:
            type: "array"
            items:
              type: "string"
        -
          name: "parameters"
          doc: "Additional parameters for tSNE function"
          type:
            type: record
            fields:
              - { name: "dims", type: "int", doc: "Output dimensionality" }
              - { name: "initial_dims", type: "int", doc: "the number of dimensions that should be retained in the initial PCA step" }
              - { name: "perplexity", type: "double", doc: "Perplexity parameter" }
              - { name: "theta", type: "double", doc: "Speed/accuracy trade-off" }
              - { name: "pca", type: "boolean", doc: "Whether an initial PCA step should be performed" }
              - { name: "max_iter", type: "int", doc: "Maximum number of iterations" }
        - { name: "sql", type: "string", doc: "SQL query" }
        - { name: "count", type: "int", doc: "Number of records selected by the query" }
    init:
      variables: {{{ variables }}}
      covariables: {{{ covariables }}}
      grouping: {{{ grouping }}}
      parameters:
        dims: {{ parameters.dims }}
        initial_dims: {{ parameters.initial_dims }}
        perplexity: {{ parameters.perplexity }}
        theta: {{ parameters.theta }}
        pca: {{ parameters.pca | lower }}
        max_iter: {{ parameters.max_iter }}
      sql: "{{ sql }}"
      count: {{ data_count }}
  reduced_data:
    type:
      doc: "New representation for the objects, with the groupings added for visualisation and further processing"
      name: ReducedData
      type: record
      fields:
        - { name: "const", type: "double", doc: "Constant of the linear regression model" }
        -
          name: "coeff"
          doc: "Coefficients of the linear regression model"
          type:
            type: array
            items:
              type: double
    init:
      const: {{ model_const }}
      coeff: {{{ model_coeff }}}
  summary:
    type:
      doc: "tSNE summary"
      name: Summary
      type: record
      fields:
        - { name: "number_of_objects", type: "int", doc: "Numer of objects" }
        - { name: "original_dimensionality", type: "int", doc: "Original Dimensionality before TSNE" }
        - { name: "perplexity", type: "double", doc: "Perplexity parameter" }
        - { name: "theta", type: "double", doc: "Speed/accuracy trade-off" }
        -
          name: "costs"
          doc: "The cost for every object after the final iteration"
          type:
            type: array
            items:
              type: double
        -
          name: "iter_costs"
          doc: "The total costs for all objects in every 50th + the last iteration"
          type:
            type: array
            items:
              type: double
    init:
      number_of_objects: {{ summary_number_of_objects }}
      original_dimensionality: {{ summary_original_dimensionality }}
      perplexity: {{ summary_perplexity }}
      theta: {{ summary_theta }}
      costs: {{{ summary_costs }}}
      iter_costs: {{{ summary_iter_costs }}}

action:
  - null

...
